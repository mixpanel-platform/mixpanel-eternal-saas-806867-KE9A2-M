<html>
  <head>
    <meta charset="utf-8">
    <link rel="stylesheet" type="text/css" href="https://cdn.mxpnl.com/libs/mixpanel-platform/css/reset.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.mxpnl.com/libs/mixpanel-platform/build/mixpanel-platform.v0.latest.min.css">
    <script src="https://cdn.mxpnl.com/libs/mixpanel-platform/build/mixpanel-platform.v0.latest.min.js"></script>
  </head>
  <body class="mixpanel-platform-body">
  <script id='query'>
    function main() {
      return Events({
          from_date: params.from_date,
          to_date: params.to_date,
      })
      .filter(function(event) {return event.name == params.event;})
      .groupBy([event => event.properties[params.property]], function(accumulators, items) {
          var ret = items.length;
          _.each(accumulators, function(accum) {ret += accum;});
          return ret;
      });
    }
  </script>
  <div id='events'></div>
  <div id='properties'></div>
  <div id="table" style='width:943px'></div>
  <script>
	var script = document.getElementById('query').innerHTML;
  var eventSelect = $('#events').MPEventSelect();
  var propSelect = $('#properties').MPPropertySelect();
  propSelect.MPPropertySelect('setEvent');
  var eventTable = $('#table').MPTable({showPercentages: false, firstColHeader: 'Frequency'});
	function runQuery() {
    var params = {
      'from_date': new Date(new Date().valueOf() - (29 * 24 * 60 * 60 * 1000)).toISOString().slice(0,-14),
		  'to_date': new Date().toISOString().slice(0,-14),
		  'event': eventSelect.MPEventSelect('value'),
      'property': propSelect.MPPropertySelect('value')
		};
		MP.api.custom_query(script, params).done(function(results) {
      var res = _.chain(results).map(function(item) {var obj = {}; obj.Property = item.key[0]? item.key[0]: 'No Property'; obj.Count = item.value; return obj;}).sortBy(item => -1 * item.Count).value();res.unshift(''); delete res[0];
		  eventTable.MPTable('setData', res);
		});
	}
	eventSelect.on('change', function() {runQuery();});
	propSelect.on('change', function() {runQuery();});
  </script>
  </body>
</html>